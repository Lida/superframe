!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var i=e();for(var s in i)("object"==typeof exports?exports:t)[s]=i[s]}}("undefined"!=typeof self?self:this,function(){return function(t){function e(s){if(i[s])return i[s].exports;var n=i[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var i={};return e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:s})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=1)}([function(t,e,i){"use strict";function s(t,e,i){return f[e]||(f[e]=new Function("state","item","return "+n(e)+";")),f[e](t,i)}function n(t){return t=t.replace(p,'["$1"]'),t=t.replace(m,'$1state["$2"]'),t=t.replace(y,'$1$2$3state["$4"]'),t=t.replace(b,"item")}function a(t){for(var e in t)delete t[e]}function r(){var t,e,i,s=arguments;for(i={},e=0;e<s.length;e++)for(t in s[e])t in i?i[t].constructor===Array?i[t].push(s[e][t]):i[t]=[i[t],s[e][t]]:i[t]=s[e][t];for(t in i)i[t].constructor===Array&&(i[t]=o.apply(this,i[t]));return i}function o(){var t=arguments;return function(){var e;for(e=0;e<t.length;e++)t[e].apply(this,arguments)}}function d(t,e,i){var s,n;for(n=u(e,g),s=0;s<n.length;s++)if(-1===v.indexOf(n[s])&&!n[s].startsWith("'")&&-1===t.indexOf(n[s])){if(i&&"item"===n[s])continue;t.push(h(n[s]).replace(A,""))}return t}function h(t){var e;return t=c(t.trim()),e=t.indexOf("."),-1===e?t:t.substring(0,t.indexOf("."))}function c(t){return 0===t.indexOf("!!")?t.replace("!!",""):0===t.indexOf("!")?t.replace("!",""):t}function u(t,e){return S[e]||(S[e]={}),S[e][t]?S[e][t]:(S[e][t]=t.split(e),S[e][t])}function l(t,e){var i;for(t.length=0,i=0;i<e.length;i++)t[i]=e[i]}var f={};t.exports.select=s;var p=/\.([A-Za-z][\w_-]*)/g,y=/([=&|!?:+-])(\s*)([\(]?)([A-Za-z][\w_-]*)/g,m=/^([\(]?)([A-Za-z][\w_-]*)/g,b=/state\["item"\]/g;t.exports.generateExpression=n,t.exports.clearObject=a,t.exports.composeHandlers=r,t.exports.composeFunctions=o;var v=["||","&&","!=","!==","==","===",">","<","<=",">="],g=/\s+/,A=/\(|\)|\!/g;t.exports.parseKeysToWatch=d;var S={};t.exports.split=u,t.exports.copyArray=l},function(t,e,i){"use strict";var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i(2);var n=i(3),a=i(0),r=i(4).wrapArray,o={initialState:{},nonBindedStateKeys:[],handlers:{},computeState:[function(){}]};AFRAME.registerState=function(t){var e=o.computeState;t.computeState&&e.push(t.computeState),AFRAME.utils.extendDeep(o,t),o.computeState=e},AFRAME.registerSystem("state",{init:function(){var t,e=this;this.arrays=[],this.dirtyArrays=[],this.diff={},this.state=AFRAME.utils.clone(o.initialState),this.subscriptions=[],this.initEventHandlers();for(t in this.state)this.state[t]&&this.state[t].constructor===Array&&(this.arrays.push(t),this.state[t].__dirty=!0,r(this.state[t]));this.lastState=AFRAME.utils.clone(this.state),this.eventDetail={lastState:this.lastState,state:this.state},this.el.addEventListener("loaded",function(){var t;for(t=0;t<o.computeState.length;t++)o.computeState[t](e.state,"@@INIT");for(t=0;t<e.subscriptions.length;t++)e.subscriptions[t].onStateUpdate(e.state)})},dispatch:function(){var t=[];return function(e,i){var s,a;for(o.handlers[e](this.state,i),s=0;s<o.computeState.length;s++)o.computeState[s](this.state,e,i);for(a in this.diff)delete this.diff[a];for(n(this.lastState,this.state,this.diff,o.nonBindedStateKeys),this.dirtyArrays.length=0,s=0;s<this.arrays.length;s++)this.state[this.arrays[s]].__dirty&&this.dirtyArrays.push(this.arrays[s]);for(t.length=0,s=0;s<this.subscriptions.length;s++){if("bind-for"===this.subscriptions[s].name){if(!this.state[this.subscriptions[s].keysToWatch[0]].__dirty)continue}else if(!this.shouldUpdate(this.subscriptions[s].keysToWatch,this.diff,this.dirtyArrays))continue;-1===t.indexOf(this.subscriptions[s])&&t.push(this.subscriptions[s])}for(s=0;s<t.length;s++)t[s].onStateUpdate();for(a in this.state)this.state[a]&&this.state[a].constructor===Array&&(this.state[a].__dirty=!1);this.copyState(this.lastState,this.state),this.eventDetail.action=e,this.eventDetail.payload=i,this.el.emit("stateupdate",this.eventDetail)}}(),copyState:function(t,e,i){var s;for(s in e)if(i||-1===o.nonBindedStateKeys.indexOf(s))if(e[s]&&e[s].constructor===Object){if(!(s in t)){t[s]=AFRAME.utils.clone(e[s]);continue}this.copyState(t[s],e[s],!0)}else t[s]=e[s]},subscribe:function(t){this.subscriptions.push(t)},unsubscribe:function(t){this.subscriptions.splice(this.subscriptions.indexOf(t),1)},shouldUpdate:function(t,e,i){for(var s=0;s<t.length;s++)if(t[s]in e||-1!==i.indexOf(t[s]))return!0;return!1},initEventHandlers:function(){function t(t){var e=this;this.el.addEventListener(t,function(i){e.dispatch(t,i.detail)})}var e,i=[];t=t.bind(this);for(e in o.handlers)-1===i.indexOf(e)&&(i.push(e),t(e))},renderTemplate:function(){var t=/{{\s*(\w*\.)?([\w.]+)\s*}}/g;return function(e,i,n){var r,o;if(o=e,i)for(;r=t.exec(e);)o=o.replace(r[0],"object"===(void 0===i?"undefined":s(i))?a.select(i,r[2])||"":i);return n?o:document.createRange().createContextualFragment(o)}}(),select:a.select}),AFRAME.registerComponent("bind",{schema:{default:{},parse:function(t){var e,i,s,n;if(t.constructor===Object)return t;if(-1===t.indexOf(":"))return t;for(e={},s=a.split(t,";"),i=0;i<s.length;i++)n=a.split(s[i].trim(),":"),e[n[0]]=n[1].trim();return e}},multiple:!0,init:function(){var t;this.data;this.keysToWatch=[],this.onStateUpdate=this.onStateUpdate.bind(this),this.system=this.el.sceneEl.systems.state,this.id&&(t=a.split(this.id,"__")[0]),this.isNamespacedBind=this.id&&t in AFRAME.components&&!AFRAME.components[t].isSingleProp||t in AFRAME.systems,this.lastData={},this.updateObj={},this.system.subscribe(this),this.onStateUpdate=this.onStateUpdate.bind(this)},update:function(){var t,e=this.data;if(this.keysToWatch.length=0,"string"==typeof e)a.parseKeysToWatch(this.keysToWatch,e);else for(t in e)a.parseKeysToWatch(this.keysToWatch,e[t]);this.onStateUpdate()},onStateUpdate:function(){var t,e,i,n,r=!1,o=this.el;if(o.parentNode){if(this.isNamespacedBind&&a.clearObject(this.updateObj),i=this.system.state,"object"!==s(this.data)){try{n=a.select(i,this.data)}catch(t){throw new Error("[aframe-state-component] Key '"+this.data+"' not found in state. #"+this.el.getAttribute("id")+"["+this.attrName+"]")}if("object"!==(void 0===n?"undefined":s(n))&&"object"!==s(this.lastData)&&this.lastData===n)return;return AFRAME.utils.entity.setComponentProperty(o,this.id,n),void(this.lastData=n)}for(t in this.data){e=this.data[t].trim();try{n=a.select(i,e)}catch(t){throw console.log(t),new Error("[aframe-state-component] Key '"+e+"' not found in state. #"+this.el.getAttribute("id")+"["+this.attrName+"]")}if("object"===(void 0===n?"undefined":s(n))||"object"===s(this.lastData[t])||this.lastData[t]!==n){if(t in AFRAME.components&&void 0===n)return void o.removeAttribute(t);this.isNamespacedBind?this.updateObj[t]=n:AFRAME.utils.entity.setComponentProperty(o,t,n),this.lastData[t]=n}}for(r in this.updateObj);this.isNamespacedBind&&r&&o.setAttribute(this.id,this.updateObj)}},remove:function(){this.system.unsubscribe(this)}}),AFRAME.registerComponent("bind-toggle",{schema:{type:"string"},multiple:!0,init:function(){this.system=this.el.sceneEl.systems.state,this.keysToWatch=[],this.onStateUpdate=this.onStateUpdate.bind(this),this.system.subscribe(this),this.onStateUpdate()},update:function(){this.keysToWatch.length=0,a.parseKeysToWatch(this.keysToWatch,this.data)},onStateUpdate:function(){var t,e,i=this.el;t=this.system.state;try{e=a.select(t,this.data)}catch(t){throw new Error("[aframe-state-component] Key '"+this.data+"' not found in state. #"+this.el.getAttribute("id")+"["+this.attrName+"]")}e?i.setAttribute(this.id,""):i.removeAttribute(this.id)},remove:function(){this.system.unsubscribe(this)}}),t.exports={composeFunctions:a.composeFunctions,composeHandlers:a.composeHandlers,select:a.select}},function(t,e,i){"use strict";var s=i(0);AFRAME.registerComponent("bind-for",{schema:{delay:{default:0},for:{type:"string",default:"item"},in:{type:"string"},key:{type:"string"},pool:{default:0},template:{type:"string"},updateInPlace:{default:!1}},init:function(){this.system=this.el.sceneEl.systems.state,this.onStateUpdate=this.onStateUpdate.bind(this),this.keysToWatch=[],this.renderedKeys=[],this.system.subscribe(this),this.el.children[0]&&"TEMPLATE"===this.el.children[0].tagName?this.template=this.el.children[0].innerHTML.trim():this.template=document.querySelector(this.data.template).innerHTML.trim();for(var t=0;t<this.data.pool;t++)this.el.appendChild(this.generateFromTemplate(null,t))},update:function(){this.keysToWatch[0]=s.split(this.data.in,".")[0],this.onStateUpdate()},onStateUpdateNaive:function(){var t=[];return function(){var e,i=this.data,n=this.el;try{e=s.select(this.system.state,i.in)}catch(t){throw new Error("[aframe-state-component] Key '"+i.in+"' not found in state. #"+n.getAttribute("id")+"["+this.attrName+"]")}t.length=0;for(var a=0;a<e.length;a++){var r=e[a];t.push(i.key?r[i.key].toString():r.toString())}for(var o=this.getElsToRemove(t,this.renderedKeys),d=0;d<o.length;d++)o[d].parentNode.removeChild(o[d]);e.length&&this.renderItems(e,t,0)}}(),renderItems:function(t,e,i){var s,n=this,a=this.data,r=this.el,o=t[i],d=a.key?o[a.key].toString():o.toString();if(-1===this.renderedKeys.indexOf(d))s=this.generateFromTemplate(o,i),r.appendChild(s),this.renderedKeys.push(d);else{if(t.length&&t[0].constructor===String){var h=a.key?o[a.key].toString():o.toString();s=r.querySelector('[data-bind-for-value="'+h+'"]'),s.setAttribute("data-bind-for-key",i)}else{var c=this.getBindForKey(o,i);s=r.querySelector('[data-bind-for-key="'+c+'"]')}s.hasLoaded?s.emit("bindforupdate",o,!1):s.addEventListener("loaded",function(){s.emit("bindforupdate",o,!1)})}t[i+1]&&(this.data.delay?setTimeout(function(){n.renderItems(t,e,i+1)},this.data.delay):this.renderItems(t,e,i+1))},onStateUpdateInPlace:function(){var t=[];return function(){var e,i,n=this.data,a=this.el;try{e=s.select(this.system.state,n.in)}catch(t){throw console.log(t),new Error("[aframe-state-component] Key '"+n.in+"' not found in state. #"+a.getAttribute("id")+"["+this.attrName+"]")}t.length=0;for(var r=0;r<e.length;r++){var o=e[r];i=n.key?o[n.key].toString():o.toString(),t.push(i)}for(var d=this.getElsToRemove(t,this.renderedKeys),h=0;h<d.length;h++)d[h].object3D.visible=!1,d[h].setAttribute("data-bind-for-active","false"),d[h].removeAttribute("data-bind-for-key"),d[h].removeAttribute("data-bind-for-value"),d[h].hasLoaded&&d[h].emit("bindfordeactivate",null,!1),d[h].pause();e.length&&this.renderItemsInPlace(e,t,0)}}(),renderItemsInPlace:function(t,e,i){var s,n=this,a=this.data,r=this.el,o=t[i],d=this.getBindForKey(o,i),h=a.key?o[a.key].toString():o.toString();if(-1===this.renderedKeys.indexOf(h)){if(r.querySelector(':scope > [data-bind-for-active="false"]'))s=r.querySelector('[data-bind-for-active="false"]'),s.setAttribute("data-bind-for-key",d),s.setAttribute("data-bind-for-value",h),s.object3D.visible=!0,s.play(),s.setAttribute("data-bind-for-active","true"),s.hasLoaded?s.emit("bindforupdateinplace",o,!1):s.addEventListener("loaded",function(){s.emit("bindforupdateinplace",o,!1)});else{var c=this.generateFromTemplate(o,i);c.addEventListener("loaded",function(){c.emit("bindforupdateinplace",o,!1)}),r.appendChild(c)}this.renderedKeys.push(h)}else-1!==e.indexOf(h)&&(t.length&&t[0].constructor===String?(s=r.querySelector('[data-bind-for-value="'+h+'"]'),s.setAttribute("data-bind-for-key",i)):s=r.querySelector('[data-bind-for-key="'+d+'"]'),s.hasLoaded?s.emit("bindforupdateinplace",o,!1):s.addEventListener("loaded",function(){s.emit("bindforupdateinplace",o,!1)}));t[i+1]&&(this.data.delay?setTimeout(function(){n.renderItemsInPlace(t,e,i+1)},this.data.delay):this.renderItemsInPlace(t,e,i+1))},generateFromTemplate:function(t,e){var i=this.data;this.el.appendChild(this.system.renderTemplate(this.template,t));var s=this.el.children[this.el.children.length-1];if(!t)return s.setAttribute("data-bind-for-key",""),s.setAttribute("data-bind-for-active","false"),s;var n=this.getBindForKey(t,e);return s.setAttribute("data-bind-for-key",n),i.key||s.setAttribute("data-bind-for-value",t),s.setAttribute("data-bind-for-active","true"),s},getElsToRemove:function(){var t=[];return function(e,i){var s=this.data,n=this.el;t.length=0;for(var a=0;a<n.children.length;a++)if("TEMPLATE"!==n.children[a].tagName){var r=s.key?n.children[a].getAttribute("data-bind-for-key"):n.children[a].getAttribute("data-bind-for-value");-1===e.indexOf(r)&&-1!==i.indexOf(r)&&(t.push(n.children[a]),i.splice(i.indexOf(r),1))}return t}}(),getBindForKey:function(t,e){return this.data.key?t[this.data.key].toString():e.toString()},onStateUpdate:function(){this.data.updateInPlace?this.onStateUpdateInPlace():this.onStateUpdateNaive()}}),AFRAME.registerComponent("bind-item",{schema:{type:"string"},multiple:!0,init:function(){this.itemData=null,this.keysToWatch=[],this.prevValues={};var t=this.rootEl=this.el.closest("[data-bind-for-key]");if(!t)throw new Error("bind-item component must be attached to entity under a bind-for item.");t.addEventListener("bindforupdateinplace",this.updateInPlace.bind(this)),t.addEventListener("bindfordeactivate",this.deactivate.bind(this)),this.el.sceneEl.systems.state.subscribe(this)},update:function(){this.parseSelector()},updateInPlace:function(t){var e=this.propertyMap;if("false"!==this.rootEl.getAttribute("data-bind-for-active")){t&&(this.itemData=t.detail);for(var i in e){var s=this.select(this.itemData,e[i]);s!==this.prevValues[i]&&(AFRAME.utils.entity.setComponentProperty(this.el,i,s),this.prevValues[i]=s)}}},onStateUpdate:function(){this.updateInPlace()},select:function(t,e){return s.select(this.el.sceneEl.systems.state.state,e,t)},deactivate:function(){this.prevValues={}},parseSelector:function(){var t=this.propertyMap={};this.keysToWatch.length=0;var e=s.split(this.id,"__")[0];if(e in AFRAME.components&&!AFRAME.components[e].isSingleProp)for(var i=s.split(this.data,";"),n=0;n<i.length;n++){var a=s.split(i[n],":");t[this.id+"."+a[0].trim()]=a[1].trim(),s.parseKeysToWatch(this.keysToWatch,a[1].trim(),!0)}else t[this.id]=this.data,s.parseKeysToWatch(this.keysToWatch,this.data,!0)}})},function(t,e,i){"use strict";t.exports=function(){var t=[];return function(e,i,s,n){var a,r,o,d,h,c,u;d=s||{},t.length=0;for(h in e)t.push(h);if(!i)return d;for(o in i)-1===t.indexOf(o)&&t.push(o);for(c=0;c<t.length;c++)h=t[c],n&&-1!==n.indexOf(h)||(a=e[h],r=i[h],((u=a&&r&&a.constructor===Object&&r.constructor===Object)&&!AFRAME.utils.deepEqual(a,r)||!u&&a!==r)&&(d[h]=r));return d}}()},function(t,e,i){"use strict";function s(t){var e;if(!t.__wrapped){for(e=0;e<a.length;e++)n(t,a[e]);t.__wrapped=!0}}function n(t,e){var i=t[e];t[e]=function(){i.apply(t,arguments),t.__dirty=!0}}var a=["push","pop","shift","unshift","splice"];t.exports.wrapArray=s}])});